<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Time Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏰</text></svg>">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-dot {
            height: 12px;
            width: 12px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background-color: #10b981; /* green-500 */
        }
        .status-offline {
            background-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container my-8 p-8 bg-white rounded-xl shadow-lg">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Focus Time Tracker</h1>
            <p class="text-gray-500 text-lg">Achieve your goals, one focus session at a time.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <section class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Current Session</h2>
                
                <div class="flex items-center text-gray-500 mb-4">
                    <span id="syncStatusDot" class="status-dot status-offline"></span>
                    <span id="syncStatusText">Offline</span>
                </div>

                <div class="text-center mb-6">
                    <div id="timerDisplay" class="text-7xl font-mono font-bold text-gray-900 mb-2">00:00:00</div>
                    <div id="currentTaskDisplay" class="text-xl font-semibold text-indigo-600 truncate">No Task</div>
                </div>

                <div class="mb-6">
                    <input type="text" id="taskInput" placeholder="What are you working on?" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <button id="startBtn" class="bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        Start
                    </button>
                    <button id="pauseBtn" class="bg-yellow-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-500" style="display: none;">
                        Pause
                    </button>
                    <button id="resumeBtn" class="bg-yellow-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-500" style="display: none;">
                        Resume
                    </button>
                    <button id="stopBtn" class="bg-red-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Stop
                    </button>
                    <button id="resetBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Reset
                    </button>
                </div>
            </section>

            <section class="p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Your Stats</h2>
                <div class="grid grid-cols-2 gap-4 text-center mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <p class="text-3xl font-bold text-blue-800" id="todayTotal">0h 0m</p>
                        <p class="text-sm text-blue-600">Today</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <p class="text-3xl font-bold text-purple-800" id="weekTotal">0h 0m</p>
                        <p class="text-sm text-purple-600">This Week</p>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Weekly Focus</h3>
                    <canvas id="weeklyChart"></canvas>
                </div>
            </section>

        </main>

        <section class="mt-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Focus Log</h2>
            <div id="logList" class="space-y-3">
                </div>
            <div class="text-center mt-6">
                <button id="showMoreLogBtn" class="text-indigo-600 font-semibold hover:text-indigo-800 transition-colors">
                    Show All Entries
                </button>
            </div>
        </section>

    </div>

    <script>
        // Data and State
        let focusSessions = JSON.parse(localStorage.getItem('focusSessions')) || [];
        let timer = null;
        let startTime = 0;
        let elapsedPausedTime = 0;
        let isRunning = false;
        let isPaused = false;
        let showAllLogEntries = false;

        // DOM Elements
        const timerDisplay = document.getElementById('timerDisplay');
        const taskInput = document.getElementById('taskInput');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const todayTotalDisplay = document.getElementById('todayTotal');
        const weekTotalDisplay = document.getElementById('weekTotal');
        const logList = document.getElementById('logList');
        const currentTaskDisplay = document.getElementById('currentTaskDisplay');
        const weeklyChartCanvas = document.getElementById('weeklyChart');
        const syncStatusDot = document.getElementById('syncStatusDot');
        const syncStatusText = document.getElementById('syncStatusText');
        const showMoreLogBtn = document.getElementById('showMoreLogBtn');
        const favicon = document.querySelector("link[rel='icon']");

        let weeklyChart;

        // --- Utility Functions ---

        // Formats seconds into HH:MM:SS
        const formatTime = (seconds) => {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        };

        // Formats seconds into Hh M m
        const formatDuration = (seconds) => {
            if (seconds < 60) return `${seconds}s`;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            let result = '';
            if (h > 0) result += `${h}h `;
            if (m > 0) result += `${m}m`;
            return result.trim();
        };

        const getStartOfToday = () => {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        };

        const getStartOfWeek = () => {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (Sunday) to 6 (Saturday)
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Monday-start week
            return new Date(now.getFullYear(), now.getMonth(), diff).getTime();
        };

        const updateFavicon = (time) => {
            const m = Math.floor(time / 60);
            const s = time % 60;
            const emoji = "⏰";
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>${emoji}</text><text x='50%' y='90%' font-size='35' dominant-baseline='middle' text-anchor='middle' font-family='monospace'>${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}</text></svg>`;
            const url = `data:image/svg+xml,${encodeURIComponent(svg)}`;
            favicon.href = url;
        };

        // --- Data & Storage ---

        const saveSessions = () => {
            try {
                localStorage.setItem('focusSessions', JSON.stringify(focusSessions));
            } catch (e) {
                console.error("Failed to save to localStorage:", e);
                showOfflineWarning();
            }
        };

        const showOfflineWarning = () => {
            syncStatusDot.classList.remove('status-online');
            syncStatusDot.classList.add('status-offline');
            syncStatusText.textContent = "Offline (can't save)";
            alert("Warning: Local storage is not available or full. Your data may not be saved.");
        };

        const updateStats = () => {
            const today = getStartOfToday();
            const thisWeek = getStartOfWeek();
            let todayTotalSeconds = 0;
            let weekTotalSeconds = 0;

            focusSessions.forEach(session => {
                if (session.date >= today) {
                    todayTotalSeconds += session.duration;
                }
                if (session.date >= thisWeek) {
                    weekTotalSeconds += session.duration;
                }
            });

            todayTotalDisplay.textContent = formatDuration(todayTotalSeconds);
            weekTotalDisplay.textContent = formatDuration(weekTotalSeconds);
        };

        // --- Rendering ---

        const renderLog = () => {
            logList.innerHTML = '';
            const today = getStartOfToday();
            const yesterday = today - (24 * 60 * 60 * 1000);
            
            let sortedSessions = [...focusSessions].sort((a, b) => b.date - a.date);

            if (!showAllLogEntries) {
                sortedSessions = sortedSessions.filter(session => session.date >= yesterday);
            }
            
            let lastDate = null;

            sortedSessions.forEach(session => {
                const sessionDate = new Date(session.date);
                const isToday = sessionDate.getTime() >= today;
                const isYesterday = !isToday && sessionDate.getTime() >= yesterday;

                let dateHeading = '';
                if (!lastDate || sessionDate.toLocaleDateString() !== lastDate.toLocaleDateString()) {
                    if (isToday) {
                        dateHeading = `<p class="text-sm text-gray-500 font-semibold mt-4 mb-1">Today</p>`;
                    } else if (isYesterday) {
                        dateHeading = `<p class="text-sm text-gray-500 font-semibold mt-4 mb-1">Yesterday</p>`;
                    } else {
                        dateHeading = `<p class="text-sm text-gray-500 font-semibold mt-4 mb-1">${sessionDate.toLocaleDateString()}</p>`;
                    }
                    logList.innerHTML += dateHeading;
                }

                const logEntry = document.createElement('div');
                logEntry.className = 'flex justify-between items-center bg-gray-100 p-4 rounded-lg';
                logEntry.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate">${session.task}</p>
                        <p class="text-sm text-gray-500">${new Date(session.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                    <div class="text-right ml-4">
                        <p class="font-bold text-lg text-indigo-600">${formatDuration(session.duration)}</p>
                    </div>
                `;
                logList.appendChild(logEntry);
                lastDate = sessionDate;
            });
            
            showMoreLogBtn.textContent = showAllLogEntries ? "Show Recent Entries" : "Show All Entries";
        };

        const renderWeeklyChart = () => {
            if (weeklyChart) {
                weeklyChart.destroy();
            }

            const sessionsByDay = new Map();
            const now = new Date();
            const startOfWeek = getStartOfWeek();
            
            // Initialize with 0 for the last 7 days
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                sessionsByDay.set(day.toLocaleDateString(), 0);
            }

            // Populate with data from focus sessions
            focusSessions.forEach(session => {
                const sessionDate = new Date(session.date);
                if (sessionDate >= startOfWeek && sessionDate <= now) {
                    const dateString = sessionDate.toLocaleDateString();
                    sessionsByDay.set(dateString, (sessionsByDay.get(dateString) || 0) + session.duration);
                }
            });

            const labels = Array.from(sessionsByDay.keys()).map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { weekday: 'short' });
            });
            const data = Array.from(sessionsByDay.values()).map(seconds => seconds / 60); // Convert to minutes

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Focus Time (minutes)',
                    data: data,
                    backgroundColor: 'rgba(99, 102, 241, 0.5)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            };

            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (minutes)'
                            },
                            grid: {
                                drawBorder: false,
                            },
                        },
                        x: {
                             grid: {
                                drawBorder: false,
                                display: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const hours = Math.floor(value / 60);
                                    const minutes = Math.round(value % 60);
                                    return `${hours}h ${minutes}m`;
                                }
                            }
                        }
                    }
                }
            };
            weeklyChart = new Chart(weeklyChartCanvas, config);
        };

        // --- Timer Logic ---

        const updateTimerDisplay = () => {
            const now = Date.now();
            const elapsed = Math.floor((now - startTime) / 1000) + elapsedPausedTime;
            timerDisplay.textContent = formatTime(elapsed);
            updateFavicon(elapsed);
        };

        const startTimer = () => {
            if (isRunning) return;

            const task = taskInput.value.trim() || `Focus Session #${focusSessions.length + 1}`;
            currentTaskDisplay.textContent = task;
            
            startTime = Date.now();
            elapsedPausedTime = 0;
            isRunning = true;
            isPaused = false;
            
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'block';
            resumeBtn.style.display = 'none';

            timer = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay(); // Initial call to prevent 1-second delay
        };

        const pauseTimer = () => {
            if (!isRunning || isPaused) return;
            
            const now = Date.now();
            elapsedPausedTime = Math.floor((now - startTime) / 1000) + elapsedPausedTime;
            isRunning = false;
            isPaused = true;
            
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'block';

            clearInterval(timer);
        };

        const resumeTimer = () => {
            if (isRunning || !isPaused) return;

            startTime = Date.now();
            isRunning = true;
            isPaused = false;
            
            pauseBtn.style.display = 'block';
            resumeBtn.style.display = 'none';

            timer = setInterval(updateTimerDisplay, 1000);
        };

        const stopTimer = () => {
            clearInterval(timer);
            if (!isRunning && !isPaused) return;

            const now = Date.now();
            const duration = Math.floor((now - startTime) / 1000) + elapsedPausedTime;
            
            if (duration > 5) { // Only save sessions longer than 5 seconds
                const task = currentTaskDisplay.textContent;
                const newSession = {
                    task,
                    duration,
                    date: Date.now()
                };
                focusSessions.push(newSession);
                saveSessions();
                renderLog();
                updateStats();
                renderWeeklyChart();
            }

            // Reset state and UI
            isRunning = false;
            isPaused = false;
            startTime = 0;
            elapsedPausedTime = 0;
            timerDisplay.textContent = '00:00:00';
            currentTaskDisplay.textContent = 'No Task';
            startBtn.style.display = 'block';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            taskInput.value = '';
            
            // Reset favicon
            favicon.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏰</text></svg>";
        };

        const resetTimer = () => {
            stopTimer(); // This function already handles the full reset
        };

        // --- Initialization ---
        const initApp = () => {
            try {
                // Check if localStorage is available
                if (typeof(Storage) === "undefined") {
                    showOfflineWarning();
                } else {
                    syncStatusDot.classList.remove('status-offline');
                    syncStatusDot.classList.add('status-online');
                    syncStatusText.textContent = "Synced";
                }

                // Initial render of UI elements
                updateStats();
                renderLog();
                renderWeeklyChart();

                // Event Listeners
                startBtn.addEventListener('click', startTimer);
                stopBtn.addEventListener('click', stopTimer);
                pauseBtn.addEventListener('click', pauseTimer);
                resumeBtn.addEventListener('click', resumeTimer);
                resetBtn.addEventListener('click', resetTimer);

                // Event listener for the new "Show More" button
                if (showMoreLogBtn) {
                    showMoreLogBtn.addEventListener('click', () => {
                        showAllLogEntries = !showAllLogEntries; // Toggle the state
                        renderLog(); // Re-render to show all entries or just today/yesterday
                    });
                }


            } catch (e) {
                console.error("Critical error during app initialization:", e);
                // Display a prominent error message to the user
                const appContainer = document.querySelector('.container');
                if (appContainer) {
                    appContainer.innerHTML = `<div class="text-red-600 text-center text-2xl font-bold">
                        <p>An unexpected error occurred during app startup.</p>
                        <p>Please check the console for details.</p>
                    </div>`;
                } else {
                    document.body.innerHTML = `<div class="text-red-600 text-center text-2xl font-bold">
                        <p>An unexpected error occurred during app startup.</p>
                        <p>Please check the console for details.</p>
                    </div>`;
                }
            }
        }

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</html>
