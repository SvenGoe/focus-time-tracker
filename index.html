<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Time Tracker</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏲️</text></svg>">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 2rem; background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; border: none; cursor: pointer; }
        .btn:disabled { background-color: #d1d5db; color: #6b7280; cursor: not-allowed; }
        .btn-green { background-color: #10B981; color: white; }
        .btn-green:hover:not(:disabled) { background-color: #059669; }
        .btn-red { background-color: #EF4444; color: white; }
        .btn-red:hover:not(:disabled) { background-color: #DC2626; }
        .btn-blue { background-color: #3B82F6; color: white; }
        .btn-blue:hover:not(:disabled) { background-color: #2563EB; }
        .btn-orange { background-color: #F97316; color: white; }
        .btn-orange:hover:not(:disabled) { background-color: #EA580C; }
        .btn-yellow { background-color: #F59E0B; color: white; }
        .btn-yellow:hover:not(:disabled) { background-color: #D97706; }
        .view-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; background-color: #E5E7EB; color: #374151; transition: background-color 0.2s ease-in-out; }
        .view-btn.active { background-color: #3B82F6; color: white; }
        .view-btn:hover:not(.active) { background-color: #D1D5DB; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 450px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; line-height: 1; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .log-entry-item { background-color: #f8f8f8; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
        @media (min-width: 640px) { .log-entry-item { flex-direction: row; justify-content: space-between; align-items: center; } }
        .toggle-checkbox { position: absolute; display: block; width: 1.5rem; height: 1.5rem; border-radius: 9999px; background-color: white; border: 4px solid transparent; -webkit-appearance: none; -moz-appearance: none; appearance: none; cursor: pointer; transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out; left: 0; }
        .toggle-checkbox:checked { border-color: #10B981; transform: translateX(1rem); }
        .toggle-label { display: block; overflow: hidden; height: 1.5rem; border-radius: 9999px; background-color: #D1D5DB; cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        .calendar-day { transition: all 0.2s ease-in-out; border: 2px solid transparent; }
        .calendar-day:hover { transform: scale(1.05); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .day-off-explicit { background-color: #fca5a5 !important; color: #b91c1c; font-weight: bold; border-color: #ef4444; }
        .today { border: 2px solid #3B82F6; }
        .star-rating .fa-star { color: #e5e7eb; cursor: pointer; transition: color 0.2s; font-size: 1.5rem; }
        #reflectionModal .star-rating .fa-star { font-size: 2rem; }
        .star-rating .fa-star.hover, .star-rating .fa-star.selected { color: #f59e0b; }
        .log-star { font-size: 0.8rem; color: #f59e0b;}
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white rounded-xl shadow-lg p-8 w-full">
        <div class="w-full flex justify-between items-center mb-6">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock text-blue-600 mr-3"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <h1 class="text-2xl md:text-4xl font-bold text-gray-800">Focus Time Tracker</h1>
            </div>
            <div id="authContainer" class="flex items-center space-x-3"></div>
        </div>
        <div id="loadingMessage" class="text-xl text-gray-700 text-center py-10">Initializing...</div>
        <div id="appSection" class="w-full hidden">
            <div class="bg-white rounded-lg shadow-md p-6 text-center border border-gray-200 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <div class="flex justify-center space-x-4 mb-4">
                            <button id="stopwatchModeBtn" class="view-btn active">Stopwatch</button>
                            <button id="countdownModeBtn" class="view-btn">Countdown</button>
                        </div>
                        <div id="timerDisplay" class="text-6xl font-extrabold text-blue-600 mb-6 p-4 bg-blue-50 rounded-lg">00:00:00</div>
                        <div class="flex justify-center space-x-4">
                            <button id="togglePauseBtn" class="btn btn-green shadow-md">Start Focusing</button>
                            <button id="endFocusBtn" class="btn btn-red shadow-md">End Focusing</button>
                        </div>
                    </div>
                    <div class="flex flex-col justify-between space-y-6">
                        <div class="p-4 bg-yellow-50 rounded-lg shadow-inner h-full flex flex-col justify-center items-center">
                            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Disruptions</h3>
                             <p class="text-3xl font-bold text-yellow-900 mb-3" id="sessionDisruptionsDisplay">0</p>
                            <button id="logDisruptionBtn" class="btn btn-yellow w-full" disabled>Log Disruption</button>
                        </div>
                        <div class="flex justify-around items-center pt-4 border-t">
                            <div class="flex items-center space-x-3">
                                <label for="notificationToggle" class="text-gray-700 font-medium">Reminders</label>
                                <div class="relative inline-block w-10 align-middle select-none">
                                    <input type="checkbox" name="notificationToggle" id="notificationToggle" class="toggle-checkbox"/>
                                    <label for="notificationToggle" class="toggle-label"></label>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label for="focusMusicToggle" class="text-gray-700 font-medium">Music</label>
                                <div class="relative inline-block w-10 align-middle select-none">
                                    <input type="checkbox" name="focusMusicToggle" id="focusMusicToggle" class="toggle-checkbox"/>
                                    <label for="focusMusicToggle" class="toggle-label"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="w-full p-6 bg-purple-50 rounded-lg shadow-inner mb-8">
                 <div class="flex justify-center items-center relative mb-6">
                    <h2 class="text-2xl font-semibold text-purple-700 text-center">KPI Dashboard</h2>
                    <button id="openGoalsModalBtn" class="btn btn-blue absolute right-0">Set Goals</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h3 class="font-semibold text-gray-600">Today's Progress</h3><p id="todayProgressText" class="text-2xl font-bold text-blue-600 my-2">0 / 0 min</p><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="todayProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s;"></div></div></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h3 class="font-semibold text-gray-600">Avg Session Goal</h3><p id="avgSessionText" class="text-2xl font-bold text-green-600 my-2">0 / 0 min</p><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="avgSessionProgressBar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s;"></div></div></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h3 class="font-semibold text-gray-600">Today's Mins/Disruption</h3><div class="flex items-center justify-center my-2"><div class="text-4xl mr-2">🎯</div><p id="minsPerDisruptionText" class="text-2xl font-bold text-red-500">0 min</p></div><p class="text-xs text-gray-500">Goal: <span id="minsPerDisruptionGoalText">N/A</span></p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center"><h3 class="font-semibold text-gray-600">Focus Streak</h3><div class="flex items-center justify-center my-2"><div class="text-4xl mr-2">🔥</div><p id="streakText" class="text-2xl font-bold text-orange-500">0 Days</p></div><p class="text-xs text-gray-500">Consecutive days meeting your goal</p></div>
                </div>
            </div>

            <div class="w-full p-6 bg-yellow-50 rounded-lg shadow-inner mb-8">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-4 text-center">Focus Time Trends</h2>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
                    <select id="chartTypeSelect" class="p-2 rounded-md border-gray-300 shadow-sm">
                        <option value="totalTime">Avg Daily Focus Time</option>
                        <option value="avgSession">Avg Session Length</option>
                        <option value="minsPerDisruption">Avg Mins per Disruption</option>
                        <option value="avgQuality">Avg Focus Quality</option>
                        <option value="reasonBubbleChart">Reasons for Low Quality</option>
                    </select>
                    <div class="flex space-x-2">
                        <button id="viewDay" class="view-btn active">Day</button>
                        <button id="viewWeek" class="view-btn">Week</button>
                        <button id="viewMonth" class="view-btn">Month</button>
                        <button id="viewYear" class="view-btn">Year</button>
                    </div>
                </div>
                <div class="relative h-80 w-full"><canvas id="timeChart"></canvas></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-10">
                <div class="lg:col-span-2 w-full p-6 bg-blue-50 rounded-lg shadow-inner">
                    <div class="mb-6 p-4 border border-blue-200 rounded-lg">
                        <h3 class="text-xl font-medium text-blue-600 mb-3">Add New Focus Entry</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="newEntryDate" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="newEntryDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></div>
                             <div class="flex space-x-2">
                                <div class="flex-1"><label for="newEntryHours" class="block text-sm font-medium text-gray-700">Hours</label><input type="number" id="newEntryHours" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></div>
                                <div class="flex-1"><label for="newEntryMinutes" class="block text-sm font-medium text-gray-700">Minutes</label><input type="number" id="newEntryMinutes" min="0" max="59" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></div>
                            </div>
                            <div><label for="newEntryDisruptions" class="block text-sm font-medium text-gray-700">Disruptions</label><input type="number" id="newEntryDisruptions" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Quality</label>
                                <div class="star-rating flex items-center mt-2" data-rating="3" id="newEntryStarRating">
                                    <i class="fa-solid fa-star selected" data-value="1"></i><i class="fa-solid fa-star selected" data-value="2"></i><i class="fa-solid fa-star selected" data-value="3"></i><i class="fa-solid fa-star" data-value="4"></i><i class="fa-solid fa-star" data-value="5"></i>
                                </div>
                            </div>
                        </div>
                        <button id="addEntryBtn" class="btn btn-blue mt-4 w-full">Add Entry</button>
                    </div>
                    <h2 class="text-2xl font-semibold text-blue-700 mb-4 text-center">Focus Time Log</h2>
                    <div id="logEntries" class="space-y-3"><p class="text-center text-gray-500">No focus entries yet.</p></div>
                    <button id="showMoreLogBtn" class="text-blue-600 hover:text-blue-800 font-medium py-2 px-4 rounded-md w-full mt-4 hidden">Show More</button>
                </div>
                <div class="p-6 bg-red-50 rounded-lg shadow-inner">
                    <h2 class="text-xl font-bold text-red-700 mb-4">Manage Days Off</h2>
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                        <h3 id="calendarMonthYear" class="text-lg font-semibold"></h3>
                        <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span id="closeAuthModalBtn" class="close-button">&times;</span>
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Welcome!</h2>
            <p class="text-gray-600 mb-6 text-center">Sign in or create an account to save your progress.</p>
            <input type="email" id="authEmail" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg"/>
            <input type="password" id="authPassword" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg"/>
            <p id="authErrorMessage" class="text-red-500 mb-4 text-center h-5"></p>
            <div class="flex flex-col space-y-3">
                <div class="flex space-x-3 w-full">
                    <button id="signInBtn" class="flex-1 btn btn-blue">Sign In</button>
                    <button id="createAccountBtn" class="flex-1 btn btn-green">Create Account</button>
                </div>
                <button id="anonymousSignInBtn" class="w-full btn bg-gray-600 hover:bg-gray-700 text-white">Continue Anonymously</button>
            </div>
        </div>
    </div>
    <div id="messageModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><p id="modalMessage" class="text-gray-700 text-lg"></p><div class="mt-4 flex justify-end"><button id="modalOkBtn" class="btn btn-blue">OK</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><p id="confirmMessage" class="text-gray-700 text-lg"></p><div class="mt-4 flex justify-end space-x-2"><button id="confirmCancelBtn" class="btn btn-red">Cancel</button><button id="confirmOkBtn" class="btn btn-blue">Confirm</button></div></div></div>
    <div id="countdownModal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Set Countdown</h3><input type="number" id="countdownMinutes" min="1" value="25" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"><div class="mt-6 flex justify-end space-x-3"><button id="cancelCountdownBtn" class="btn bg-gray-300">Cancel</button><button id="startCountdownBtn" class="btn btn-blue">Start</button></div></div></div>
    <div id="medalModal" class="modal"><div class="modal-content text-center"><div class="text-8xl mb-4">🏅</div><h3 class="text-2xl font-bold text-yellow-500 mb-2">Focus Session Complete!</h3><p class="text-gray-600">Great work! You've successfully completed your countdown session.</p><div class="mt-6"><button id="closeMedalModalBtn" class="btn btn-blue w-full">Reflect on Session</button></div></div></div>
    <div id="disruptionPromptModal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Pausing Focus</h3><p class="mb-4">Did a disruption cause you to pause?</p><div class="mt-6 flex justify-between items-center"><button id="justPauseBtn" class="btn bg-gray-400">Just Pause</button><button id="logDisruptionFromPauseBtn" class="btn btn-yellow">Log Disruption & Pause</button></div><button id="cancelPauseBtn" class="btn bg-gray-200 text-gray-800 w-full mt-4">Nevermind</button></div></div></div>
    <div id="logDisruptionModal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Log a Disruption</h3><div><label for="penaltyMinutesInput">Penalty Minutes (subtracted from timer)</label><input type="number" id="penaltyMinutesInput" min="0" value="5" class="mt-1 block w-full p-2 border rounded-md"></div><div class="mt-6 flex justify-end space-x-3"><button id="cancelLogDisruptionBtn" class="btn bg-gray-300">Cancel</button><button id="confirmLogDisruptionBtn" class="btn btn-yellow">Log It</button></div></div></div>
    <div id="reflectionModal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Reflection</h3><p id="reflectionSuggestionText" class="text-sm text-gray-600 mb-4"></p><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Focus Quality</label><div class="star-rating flex justify-center" data-rating="0"><i class="fa-solid fa-star" data-value="1"></i><i class="fa-solid fa-star" data-value="2"></i><i class="fa-solid fa-star" data-value="3"></i><i class="fa-solid fa-star" data-value="4"></i><i class="fa-solid fa-star" data-value="5"></i></div></div><div class="mt-6 flex justify-end"><button id="confirmReflectionBtn" class="btn btn-red">Next</button></div></div></div>
    <div id="goalsModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2 class="text-xl font-bold mb-4">Set Goals</h2><div class="space-y-4"><div><label for="todayFocusGoal">Today’s Focus Time (min)</label><input type="number" id="todayFocusGoal" class="mt-1 block w-full p-2 border rounded-md"></div><div><label for="avgSessionGoal">Avg Session Duration (min)</label><input type="number" id="avgSessionGoal" class="mt-1 block w-full p-2 border rounded-md"></div><div><label for="disruptionGoal">Mins per Disruption Goal</label><input type="number" id="disruptionGoal" class="mt-1 block w-full p-2 border rounded-md"></div></div><button id="saveGoalsBtn" class="btn btn-blue mt-6 w-full">Save Goals</button></div></div>
    <div id="editLogModal" class="modal"></div>
    <div id="reasonModal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Reason for Low Quality</h3><p class="text-sm text-gray-600 mb-4">Select a past reason or add a new one.</p><div id="pastReasonsContainer" class="flex flex-wrap gap-2 mb-4"></div><input type="text" id="newReasonInput" placeholder="New reason (e.g., Low Energy)" class="w-full p-2 border rounded-md"><div class="mt-6 flex justify-end"><button id="saveReasonBtn" class="btn btn-blue">Save & Continue</button></div></div></div>
    <div id="improvementModal" class="modal"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Self-Reflection</h3><p class="text-sm text-gray-600 mb-4">How could you improve this next time?</p><textarea id="improvementText" rows="3" class="w-full p-2 border rounded-md"></textarea><div class="mt-6 flex justify-end"><button id="finishReflectionBtn" class="btn btn-green">Finish</button></div></div></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, updateDoc, deleteDoc, getDoc, query, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const APP_ID_FOR_FIRESTORE = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('loadingMessage').textContent = "Error: Could not connect to services.";
        }
        
        let currentUser = null, userId = null, isAuthReady = false, unsubscribe = {}, chartInstance;
        let timerInterval, startTime, running = false, isSaving = false, accumulatedTime = 0, countdownDuration = 0, sessionDisruptions = 0;
        let focusedTimeData = {}, goals = {}, daysOff = {}, lowQualityReasons = [];
        let notificationTimeoutId, notificationsEnabled, focusMusicEnabled;
        let calendarDate = new Date(), currentTimerMode = 'stopwatch', showAllLogEntries = false;
        let sessionDataForReflection = null;

        document.addEventListener('DOMContentLoaded', () => {
            notificationsEnabled = localStorage.getItem('notificationToggleState') === 'true';
            document.getElementById('notificationToggle').checked = notificationsEnabled;
            focusMusicEnabled = localStorage.getItem('focusMusicToggleState') === 'true';
            document.getElementById('focusMusicToggle').checked = focusMusicEnabled;
            document.getElementById('newEntryDate').value = new Date().toISOString().slice(0, 10);
            onAuthStateChanged(auth, user => {
                Object.values(unsubscribe).forEach(unsub => unsub());
                unsubscribe = {};
                currentUser = user;
                if (user) {
                    userId = user.uid;
                    hideAuthModal();
                    attachDataListeners(); 
                } else {
                    userId = null;
                    clearUserData();
                    showAuthModal();
                }
                updateAuthUI();
                if (!isAuthReady) {
                    isAuthReady = true;
                    document.getElementById('loadingMessage').classList.add('hidden');
                }
            });
            setupEventListeners();
        });
        
        function attachDataListeners() {
            if (!userId) return;
            let dataLoaded = { focusSessions: false, goals: false, daysOff: false, reasons: false };
            const checkAllDataLoaded = () => { if (Object.values(dataLoaded).every(v => v)) updateAllUI(); };
            const collections = {
                focusSessions: s => { focusedTimeData = {}; s.forEach(d => { focusedTimeData[d.id] = d.data() }); dataLoaded.focusSessions = true; checkAllDataLoaded() },
                goals: s => { goals = {}; s.forEach(d => { goals[d.id] = d.data() }); dataLoaded.goals = true; checkAllDataLoaded() },
                daysOff: s => { daysOff = {}; s.forEach(d => { daysOff[d.id] = d.data() }); dataLoaded.daysOff = true; checkAllDataLoaded() },
            };
            Object.entries(collections).forEach(([col, handler]) => {
                const q = query(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/${col}`));
                unsubscribe[col] = onSnapshot(q, handler, err => console.error(`Error on ${col}:`, err));
            });
            const reasonsDocRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/reflectionData/reasons`);
            unsubscribe.reasons = onSnapshot(reasonsDocRef, (docSnap) => {
                lowQualityReasons = docSnap.exists() ? docSnap.data().reasons : [];
                dataLoaded.reasons = true;
                checkAllDataLoaded();
            });
        }

        function clearUserData() {
            focusedTimeData = {};
            goals = {};
            daysOff = {};
            if(chartInstance) chartInstance.destroy();
            updateAllUI();
        }
        
        function showAuthModal() {
            const closeBtn = document.getElementById('closeAuthModalBtn');
            const anonBtn = document.getElementById('anonymousSignInBtn');
            if (currentUser && currentUser.isAnonymous) {
                closeBtn.style.display = 'block';
                anonBtn.style.display = 'none';
            } else {
                closeBtn.style.display = 'none';
                anonBtn.style.display = 'block';
            }
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('appSection').classList.add('hidden');
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authErrorMessage').textContent = '';
            document.getElementById('appSection').classList.remove('hidden');
        }

        function updateAuthUI() {
            const authContainer = document.getElementById('authContainer');
            authContainer.innerHTML = ''; 
            if (currentUser) {
                const userInfoEl = document.createElement('span');
                userInfoEl.className = 'text-gray-600 text-sm hidden sm:block';
                authContainer.appendChild(userInfoEl);
                if (currentUser.isAnonymous) {
                    userInfoEl.textContent = 'Anonymous User';
                    const registerBtn = document.createElement('button');
                    registerBtn.className = 'btn btn-green text-sm py-2 px-4';
                    registerBtn.textContent = 'Sign In / Register';
                    registerBtn.addEventListener('click', showAuthModal);
                    authContainer.appendChild(registerBtn);
                } else {
                    userInfoEl.textContent = currentUser.email;
                    const signOutBtn = document.createElement('button');
                    signOutBtn.className = 'p-2 bg-gray-200 hover:bg-gray-300 rounded-full transition-all';
                    signOutBtn.title = 'Sign Out';
                    signOutBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" y1="12" x2="10" y2="12"/></svg>`;
                    signOutBtn.addEventListener('click', () => signOut(auth));
                    authContainer.appendChild(signOutBtn);
                }
            } else {
                const signInBtn = document.createElement('button');
                signInBtn.className = 'btn btn-blue';
                signInBtn.textContent = 'Sign In / Register';
                signInBtn.addEventListener('click', showAuthModal);
                authContainer.appendChild(signInBtn);
            }
        }

        function updateAllUI() {
            if (!isAuthReady || !currentUser) return;
            updateDashboard();
            renderCalendar();
            renderChart();
            renderLog();
        }
        
        function formatTimer(s) {
            return new Date(s * 1000).toISOString().substr(11, 8);
        }
        
        function updateTimerDisplay() {
            let elapsed = accumulatedTime / 1000 + (running ? (Date.now() - startTime) / 1000 : 0);
            let displaySecs = (currentTimerMode === 'stopwatch') ? elapsed : Math.max(0, countdownDuration - elapsed);
            document.getElementById('timerDisplay').textContent = formatTimer(displaySecs);
            document.getElementById('sessionDisruptionsDisplay').textContent = sessionDisruptions;
            if (currentTimerMode === 'countdown' && displaySecs <= 0 && running) {
                completeCountdown();
            }
        }

        function completeCountdown() {
            running = false;
            clearInterval(timerInterval);
            if (isSaving) return;
            
            new Audio("https://actions.google.com/sounds/v1/impacts/gong_strike.ogg").play().catch(e => console.warn("Audio fail:", e));
            if (Notification.permission === 'granted') {
                new Notification('Focus session complete!', { 
                    body: 'Great work! Time to reflect on your session.',
                    icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏅</text></svg>"
                });
            }
            
            sessionDataForReflection = { duration: countdownDuration * 1000, disruptions: sessionDisruptions };
            document.getElementById('medalModal').style.display = 'flex';
        }
        
        function toggleTimer() {
            if (running) {
                document.getElementById('disruptionPromptModal').style.display = 'flex';
            } else if (currentTimerMode === 'countdown' && countdownDuration === 0) {
                document.getElementById('countdownModal').style.display = 'flex';
            } else {
                startTimer();
            }
        }
        
        function startTimer() {
            if (running) return;
            running = true;
            startTime = Date.now();
            timerInterval = setInterval(updateTimerDisplay, 500);
            document.getElementById('togglePauseBtn').textContent = 'Pause';
            document.getElementById('togglePauseBtn').classList.replace('btn-green', 'btn-orange');
            document.getElementById('logDisruptionBtn').disabled = false;
            if (notificationsEnabled) scheduleNextNotification();
            if (focusMusicEnabled) {
                 showMessage('Time to focus! Remember to play your favorite focus music.');
            }
        }
        
        function pauseTimer() {
            if (!running) return;
            running = false;
            clearInterval(timerInterval);
            accumulatedTime += Date.now() - startTime;
            document.getElementById('togglePauseBtn').textContent = 'Continue';
            document.getElementById('togglePauseBtn').classList.replace('btn-orange', 'btn-green');
            document.getElementById('logDisruptionBtn').disabled = true;
            clearTimeout(notificationTimeoutId);
        }
        
        function endFocusPrompt(isCountdown = false) {
            if (isCountdown && sessionDataForReflection) {
                sessionDataForReflection.isCountdown = true;
            } else {
                const totalMs = accumulatedTime + (running ? Date.now() - startTime : 0);
                if (totalMs < 1000) {
                    resetTimerState();
                    return;
                }
                pauseTimer();
                sessionDataForReflection = { duration: totalMs, disruptions: sessionDisruptions };
            }
            const modal = document.getElementById('reflectionModal');
            const stars = modal.querySelectorAll('.star-rating .fa-star');
            const suggestion = Math.max(1, 5 - sessionDataForReflection.disruptions);
            document.getElementById('reflectionSuggestionText').textContent = `With ${sessionDataForReflection.disruptions} disruptions, we suggest a quality rating of ${suggestion} stars.`;
            stars.forEach(s => s.classList.remove('selected'));
            for (let i = 0; i < suggestion; i++) {
                stars[i].classList.add('selected');
            }
            modal.querySelector('.star-rating').dataset.rating = suggestion;
            modal.style.display = 'flex';
        }

        async function stopAndSaveSession(duration, disruptions, quality, reason = null) {
            if (isSaving || duration <= 0) {
                resetTimerState();
                return;
            }
            isSaving = true;
            const today = new Date().toISOString().slice(0, 10);
            const newSession = {
                id: crypto.randomUUID(),
                duration: Math.floor(duration / 1000),
                disruptions,
                quality,
                reason,
                timestamp: new Date().toISOString()
            };
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/focusSessions`, today);
                const docSnap = await getDoc(docRef);
                const existing = docSnap.exists() && docSnap.data().sessions ? docSnap.data().sessions : [];
                await setDoc(docRef, { sessions: [...existing, newSession] }, { merge: true });
                if (reason && !lowQualityReasons.includes(reason)) {
                    const reasonsRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/reflectionData/reasons`);
                    await setDoc(reasonsRef, { reasons: arrayUnion(reason) }, { merge: true });
                }
            } catch (e) {
                showMessage("Could not save session: " + e.message);
            }
            resetTimerState();
            isSaving = false;
        }

        function resetTimerState() {
            running = false;
            clearInterval(timerInterval);
            accumulatedTime = 0;
            sessionDisruptions = 0;
            countdownDuration = 0;
            isSaving = false;
            sessionDataForReflection = null;
            updateTimerDisplay();
            document.getElementById('togglePauseBtn').textContent = 'Start Focusing';
            document.getElementById('togglePauseBtn').classList.replace('btn-orange', 'btn-green');
            document.getElementById('logDisruptionBtn').disabled = true;
        }
        
        function updateDashboard() {
            const todayStr = new Date().toISOString().slice(0, 10);
            const todaysGoalData = goals[todayStr];
            const todaySessions = focusedTimeData[todayStr]?.sessions || [];
            const totalSecondsToday = todaySessions.reduce((sum, s) => sum + s.duration, 0);
            const totalMinutesToday = Math.floor(totalSecondsToday / 60);
            const dailyGoal = todaysGoalData?.dailyGoal || 0;
            document.getElementById('todayProgressBar').style.width = `${dailyGoal > 0 ? Math.min(100, (totalMinutesToday / dailyGoal) * 100) : 0}%`;
            document.getElementById('todayProgressText').textContent = `${totalMinutesToday} / ${dailyGoal} min`;
            
            const allSessions = Object.values(focusedTimeData).flatMap(d => d.sessions || []);
            const totalFocusSecondsAllTime = allSessions.reduce((sum, s) => sum + s.duration, 0);
            const allTimeAvgMins = allSessions.length > 0 ? Math.floor((totalFocusSecondsAllTime / allSessions.length) / 60) : 0;
            const sessionGoal = todaysGoalData?.sessionGoal || 0;
            document.getElementById('avgSessionProgressBar').style.width = `${sessionGoal > 0 ? Math.min(100, (allTimeAvgMins / sessionGoal) * 100) : 0}%`;
            document.getElementById('avgSessionText').textContent = `${allTimeAvgMins} / ${sessionGoal} min`;
            
            let streak = 0;
            let d = new Date();
            while (true) {
                const dateStr = d.toISOString().slice(0, 10);
                if (isDayOff(dateStr)) {
                    d.setDate(d.getDate() - 1);
                    continue;
                }
                const dayGoal = goals[dateStr]?.dailyGoal || 0;
                const dayTotalSecs = (focusedTimeData[dateStr]?.sessions || []).reduce((sum, s) => sum + s.duration, 0);
                if (dayGoal > 0 && dayTotalSecs / 60 >= dayGoal) {
                    streak++;
                    d.setDate(d.getDate() - 1);
                } else {
                    break;
                }
            }
            document.getElementById('streakText').textContent = `${streak} Days`;

            const todayDisruptions = todaySessions.reduce((sum, s) => sum + (s.disruptions || 0), 0);
            const minsPerDisruptionToday = todayDisruptions > 0 ? Math.floor(totalMinutesToday / todayDisruptions) : totalMinutesToday;
            document.getElementById('minsPerDisruptionText').textContent = `${minsPerDisruptionToday} min`;
            document.getElementById('minsPerDisruptionGoalText').textContent = `${todaysGoalData?.disruptionGoal || 'N/A'} min`;
        }

        function isDayOff(dateStr) {
            const d = new Date(dateStr + 'T12:00:00Z');
            const day = d.getUTCDay();
            const isWknd = day === 0 || day === 6;
            const dayOff = daysOff[dateStr];
            return dayOff ? !dayOff.isWorkDay : isWknd;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            calendarDate.setDate(1);
            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            document.getElementById('calendarMonthYear').textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDay = calendarDate.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => { grid.innerHTML += `<div class="font-bold text-gray-500 text-sm">${d}</div>` });
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                dayEl.className = 'calendar-day cursor-pointer p-2 rounded-full text-sm';
                if (isDayOff(dateStr)) {
                    dayEl.classList.add('day-off-explicit');
                }
                if (i === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                    dayEl.classList.add('today');
                }
                dayEl.addEventListener('click', () => toggleDayOff(dateStr));
                grid.appendChild(dayEl);
            }
        }

        async function toggleDayOff(d) {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/daysOff`, d);
            const day = new Date(d + 'T12:00:00Z').getUTCDay();
            if (daysOff[d]) {
                await deleteDoc(docRef);
            } else {
                await setDoc(docRef, { isWorkDay: day === 0 || day === 6 });
            }
        }

        function renderChart() {
            if (chartInstance) chartInstance.destroy();
            const chartType = document.getElementById('chartTypeSelect').value;
            const viewType = document.querySelector('.view-btn.active').id.replace('view', '').toLowerCase();
            const isBubble = chartType === 'reasonBubbleChart';
            const chartData = getChartData(viewType, chartType);
            const canvas = document.getElementById('timeChart');
            
            canvas.style.display = 'block';

            if (!chartData || (chartData.labels.length === 0 && !isBubble) || (isBubble && chartData.data.length === 0)) {
                chartInstance = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { callback: (v) => v } } },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'No data available for this period.' }
                        }
                    }
                });
                return;
            }

            if (isBubble) {
                chartInstance = new Chart(canvas, {
                    type: 'bubble',
                    data: {
                        datasets: [{
                            label: 'Reasons for Low Quality',
                            data: chartData.data,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { title: { display: true, text: 'Avg Quality (Stars)' } },
                            x: { title: { display: true, text: 'Frequency' } }
                        },
                        plugins: { tooltip: { callbacks: { label: c => `${chartData.labels[c.dataIndex]}: ${c.raw.x} times, avg quality ${c.raw.y.toFixed(1)} stars` } } }
                    }
                });
            } else {
                const { labels, data, trendData, unitSuffix } = chartData;
                chartInstance = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: `Value`, data, backgroundColor: 'rgba(59, 130, 246, 0.7)', order: 2 },
                            { label: `Trend`, data: trendData, type: 'line', borderColor: '#EF4444', borderWidth: 2, pointRadius: 0, order: 1 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { callback: v => `${v.toFixed(1)}${unitSuffix}` } } }
                    }
                });
            }
        }
        
        function getChartData(viewType, chartType) {
            if (chartType === 'reasonBubbleChart') {
                const stats = {};
                Object.values(focusedTimeData).flatMap(d => d.sessions || []).forEach(s => {
                    if (s.reason && s.quality <= 3) {
                        if (!stats[s.reason]) {
                            stats[s.reason] = { count: 0, totalQ: 0 };
                        }
                        stats[s.reason].count++;
                        stats[s.reason].totalQ += s.quality;
                    }
                });
                const labels = Object.keys(stats);
                const data = labels.map(r => ({ x: stats[r].count, y: stats[r].totalQ / stats[r].count, r: stats[r].count * 5 + 5 }));
                return { labels, data };
            }

            const periods = { day: 7, week: 12, month: 12, year: 5 };
            const num = periods[viewType];
            const labels = [];
            const data = [];
            let today = new Date();
            today.setHours(12, 0, 0, 0);

            const calcVal = (d, t) => {
                const s = focusedTimeData[d]?.sessions || [];
                if (s.length === 0) return 0;
                const dur = s.reduce((sum, i) => sum + i.duration, 0);
                if (t === 'totalTime') return dur;
                if (t === 'avgSession') return dur / s.length;
                if (t === 'avgQuality') return s.reduce((sum, i) => sum + (i.quality || 0), 0) / s.length;
                const dis = s.reduce((sum, i) => sum + (i.disruptions || 0), 0);
                const mins = dur / 60;
                return dis > 0 ? mins / dis : mins;
            };

            if (viewType === 'day') {
                let workDays = [];
                let d = new Date(today);
                for (let i = 0; workDays.length < num; i++) {
                    const cur = new Date(d);
                    cur.setDate(d.getDate() - i);
                    const str = cur.toISOString().slice(0, 10);
                    if (!isDayOff(str)) {
                        workDays.unshift(cur);
                    }
                    if (i > 365) break;
                }
                labels.push(...workDays.map(d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })));
                data.push(...workDays.map(d => calcVal(d.toISOString().slice(0, 10), chartType)));
            } else {
                const ranges = [];
                for (let i = num - 1; i >= 0; i--) {
                    let s, e;
                    if (viewType === 'week') {
                        s = new Date(today);
                        s.setHours(0, 0, 0, 0);
                        s.setDate(today.getDate() - (i * 7) - today.getDay());
                        e = new Date(s);
                        e.setDate(s.getDate() + 6);
                        labels.push(`W of ${s.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`);
                    } else if (viewType === 'month') {
                        s = new Date(today.getFullYear(), today.getMonth() - i, 1);
                        e = new Date(today.getFullYear(), today.getMonth() - i + 1, 0);
                        labels.push(s.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
                    } else if (viewType === 'year') {
                        const y = today.getFullYear() - i;
                        s = new Date(y, 0, 1);
                        e = new Date(y, 11, 31);
                        labels.push(y.toString());
                    }
                    ranges.push({ s, e });
                }
                data.push(...ranges.map(r => {
                    let v = 0, c = 0;
                    Object.keys(focusedTimeData).forEach(d => {
                        const entryD = new Date(d + "T12:00:00Z");
                        if (entryD >= r.s && entryD <= r.e && !isDayOff(d)) {
                            v += calcVal(d, chartType);
                            c++;
                        }
                    });
                    return c > 0 ? v / c : 0;
                }));
            }

            let trendData = [];
            const active = data.map((y, x) => y > 0 ? { x, y } : null).filter(p => p);
            if (active.length > 1) {
                const fX = active[0].x;
                const lX = active[active.length - 1].x;
                let sX = 0, sY = 0, sXY = 0, sXX = 0, n = active.length;
                active.forEach(p => {
                    sX += p.x;
                    sY += p.y;
                    sXY += p.x * p.y;
                    sXX += p.x * p.x;
                });
                const m = (n * sXX - sX * sX) ? (n * sXY - sX * sY) / (n * sXX - sX * sX) : 0;
                const b = (sY / n) - (m * sX / n);
                trendData = data.map((_, x) => (x >= fX && x <= lX && m * x + b >= 0) ? m * x + b : null);
            }

            const max = Math.max(...data, 0);
            let unit = 's', div = 1;
            if (chartType === 'avgQuality') {
                unit = '⭐';
            } else if (chartType === 'totalTime' || chartType === 'avgSession') {
                if (max >= 3600) {
                    unit = 'h';
                    div = 3600;
                } else if (max >= 60) {
                    unit = 'm';
                    div = 60;
                }
            } else {
                unit = 'm';
            }
            return { labels, data: data.map(v => v / div), trendData: trendData.map(v => v / div), unitSuffix: unit };
        }
        
        function renderLog() {
            const logDiv = document.getElementById('logEntries');
            const moreBtn = document.getElementById('showMoreLogBtn');
            logDiv.innerHTML = '';
            const entries = Object.entries(focusedTimeData).flatMap(([d, data]) => (data.sessions || []).map(s => ({...s, date: d }))).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (entries.length === 0) {
                logDiv.innerHTML = '<p class="text-center text-gray-500">No entries yet.</p>';
                moreBtn.classList.add('hidden');
                return;
            }
            const toShow = showAllLogEntries ? entries : entries.slice(0, 5);
            toShow.forEach(e => {
                const s = e.quality ? Array(Math.round(e.quality)).fill('<i class="fa-solid fa-star log-star"></i>').join('') : '';
                const d = document.createElement('div');
                d.className = 'log-entry-item';
                d.innerHTML = `<span>${e.date} at ${new Date(e.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span class="flex items-center gap-2">${formatTimer(e.duration)} (${e.disruptions||0} dis.) <span class="text-yellow-500 flex">${s}</span></span><div class="space-x-2"><button class="text-sm text-blue-600 hover:underline edit-btn" data-date="${e.date}" data-session-id="${e.id}">Edit</button><button class="text-sm text-red-600 hover:underline delete-btn" data-date="${e.date}" data-session-id="${e.id}">Delete</button></div>`;
                logDiv.appendChild(d);
            });
            moreBtn.style.display = entries.length > 5 ? 'block' : 'none';
            moreBtn.textContent = showAllLogEntries ? 'Show Less' : 'Show More';
            document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', e => editSessionPrompt(e.target.dataset.date, e.target.dataset.sessionId)));
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', e => deleteSession(e.target.dataset.date, e.target.dataset.sessionId)));
        }
        
        async function deleteSession(date, sessionId) {
            if (!(await showConfirm('Delete this entry?'))) return;
            const updated = focusedTimeData[date].sessions.filter(s => s.id !== sessionId);
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/focusSessions`, date);
                if (updated.length > 0) {
                    await updateDoc(docRef, { sessions: updated });
                } else {
                    await deleteDoc(docRef);
                }
                showMessage('Entry deleted.');
            } catch (e) {
                showMessage('Error deleting entry.');
            }
        }
        
        function editSessionPrompt(date, sessionId) {
            const session = focusedTimeData[date]?.sessions.find(s => s.id === sessionId);
            if (!session) return;
            const modal = document.getElementById('editLogModal');
            const h = Math.floor(session.duration / 3600);
            const m = Math.floor((session.duration % 3600) / 60);
            const s = session.duration % 60;
            modal.innerHTML = `<div class="modal-content"><h3 class="text-xl font-bold mb-4">Edit Entry</h3><div class="grid grid-cols-3 gap-2"><div><label>H</label><input type="number" id="editHours" value="${h}" class="w-full p-2 border rounded"></div><div><label>M</label><input type="number" id="editMinutes" value="${m}" class="w-full p-2 border rounded"></div><div><label>S</label><input type="number" id="editSeconds" value="${s}" class="w-full p-2 border rounded"></div></div><div class="mt-2"><label>Disruptions</label><input type="number" id="editDisruptions" value="${session.disruptions||0}" class="w-full p-2 border rounded"></div><div class="mt-4 flex justify-end space-x-2"><button id="cancelEditBtn" class="btn bg-gray-300">Cancel</button><button id="saveEditBtn" class="btn btn-blue">Save</button></div></div>`;
            modal.style.display = 'flex';
            document.getElementById('saveEditBtn').onclick = () => {
                const newDur = (parseInt(document.getElementById('editHours').value) * 3600) + (parseInt(document.getElementById('editMinutes').value) * 60) + parseInt(document.getElementById('editSeconds').value);
                const newDis = parseInt(document.getElementById('editDisruptions').value);
                updateSession(date, sessionId, newDur, newDis);
                modal.style.display = 'none';
            };
            document.getElementById('cancelEditBtn').onclick = () => modal.style.display = 'none';
        }

        async function updateSession(date, id, newDur, newDis) {
            const updated = focusedTimeData[date].sessions.map(s => s.id === id ? { ...s, duration: newDur, disruptions: newDis } : s);
            try {
                await updateDoc(doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/focusSessions`, date), { sessions: updated });
                showMessage('Updated.');
            } catch (e) {
                showMessage('Error updating.');
            }
        }
        
        function setupEventListeners() {
            const authEmail = document.getElementById('authEmail');
            const authPassword = document.getElementById('authPassword');
            const authError = document.getElementById('authErrorMessage');
            
            document.getElementById('signInBtn').addEventListener('click', () => {
                authError.textContent = '';
                signInWithEmailAndPassword(auth, authEmail.value, authPassword.value)
                    .catch(e => authError.textContent = e.message);
            });

            document.getElementById('createAccountBtn').addEventListener('click', () => {
                authError.textContent = '';
                createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value)
                    .catch(e => authError.textContent = e.message);
            });

            document.getElementById('anonymousSignInBtn').addEventListener('click', () => {
                authError.textContent = '';
                signInAnonymously(auth).catch(e => authError.textContent = e.message);
            });

            document.getElementById('togglePauseBtn').addEventListener('click', toggleTimer);
            document.getElementById('endFocusBtn').addEventListener('click', () => endFocusPrompt(false));
            document.getElementById('logDisruptionBtn').addEventListener('click', () => document.getElementById('logDisruptionModal').style.display = 'flex');
            
            document.getElementById('notificationToggle').addEventListener('change', e => {
                notificationsEnabled = e.target.checked;
                localStorage.setItem('notificationToggleState', String(e.target.checked));
                if(e.target.checked && running) {
                    scheduleNextNotification();
                } else if(e.target.checked) { // Ask for permission if not running
                    Notification.requestPermission();
                }
            });

            document.getElementById('focusMusicToggle').addEventListener('change', e => {
                focusMusicEnabled = e.target.checked;
                localStorage.setItem('focusMusicToggleState', String(e.target.checked));
            });

            document.querySelectorAll('.view-btn').forEach(b => b.addEventListener('click', e => {
                document.querySelectorAll('.view-btn').forEach(i => i.classList.remove('active'));
                e.target.classList.add('active');
                renderChart();
            }));

            document.getElementById('chartTypeSelect').addEventListener('change', () => renderChart());
            
            document.getElementById('showMoreLogBtn').addEventListener('click', () => {
                showAllLogEntries = !showAllLogEntries;
                renderLog();
            });
            
            document.getElementById('addEntryBtn').addEventListener('click', async () => {
                const d = document.getElementById('newEntryDate').value;
                const h = parseInt(document.getElementById('newEntryHours').value) || 0;
                const m = parseInt(document.getElementById('newEntryMinutes').value) || 0;
                const dis = parseInt(document.getElementById('newEntryDisruptions').value) || 0;
                const q = parseInt(document.getElementById('newEntryStarRating').dataset.rating) || 3;
                if (!d || (h === 0 && m === 0)) {
                    showMessage("Date and duration required.");
                    return;
                }
                const newS = {
                    id: crypto.randomUUID(),
                    duration: (h * 3600) + (m * 60),
                    disruptions: dis,
                    quality: q,
                    timestamp: new Date(d + 'T12:00:00').toISOString()
                };
                try {
                    const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/focusSessions`, d);
                    const docSnap = await getDoc(docRef);
                    const existing = docSnap.exists() && docSnap.data().sessions ? docSnap.data().sessions : [];
                    await setDoc(docRef, { sessions: [...existing, newS] }, { merge: true });
                    
                    // Optimistic UI Update
                    if (!focusedTimeData[d]) focusedTimeData[d] = { sessions: [] };
                    focusedTimeData[d].sessions.push(newS);
                    updateAllUI(); // Rerender everything to reflect the new entry

                    showMessage("Entry added!");
                } catch (e) {
                    showMessage("Error adding.");
                }
            });
            
            document.getElementById('openGoalsModalBtn').addEventListener('click', openGoalsModal);
            
            document.getElementById('stopwatchModeBtn').addEventListener('click', () => {
                currentTimerMode = 'stopwatch';
                document.getElementById('stopwatchModeBtn').classList.add('active');
                document.getElementById('countdownModeBtn').classList.remove('active');
                resetTimerState();
            });

            document.getElementById('countdownModeBtn').addEventListener('click', () => {
                currentTimerMode = 'countdown';
                document.getElementById('countdownModeBtn').classList.add('active');
                document.getElementById('stopwatchModeBtn').classList.remove('active');
                resetTimerState();
            });

            document.getElementById('prevMonthBtn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonthBtn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            });

            document.querySelectorAll('.modal .close-button, .modal [id^=cancel], .modal [id=modalOkBtn]').forEach(b => b.addEventListener('click', e => e.currentTarget.closest('.modal').style.display = 'none'));
            
            document.getElementById('closeMedalModalBtn').addEventListener('click', () => {
                document.getElementById('medalModal').style.display = 'none';
                endFocusPrompt(true)
            });
            
            document.getElementById('startCountdownBtn').addEventListener('click', () => {
                const m = parseInt(document.getElementById('countdownMinutes').value);
                if (m > 0) {
                    countdownDuration = m * 60;
                    document.getElementById('countdownModal').style.display = 'none';
                    startTimer();
                }
            });
            
            document.getElementById('justPauseBtn').addEventListener('click', () => {
                document.getElementById('disruptionPromptModal').style.display = 'none';
                pauseTimer()
            });
            
            document.getElementById('logDisruptionFromPauseBtn').addEventListener('click', () => {
                document.getElementById('disruptionPromptModal').style.display = 'none';
                pauseTimer();
                document.getElementById('logDisruptionModal').style.display = 'flex'
            });
            
            document.getElementById('confirmLogDisruptionBtn').addEventListener('click', () => {
                sessionDisruptions++;
                accumulatedTime = Math.max(0, accumulatedTime - (parseInt(document.getElementById('penaltyMinutesInput').value) || 0) * 60 * 1000);
                document.getElementById('logDisruptionModal').style.display = 'none';
                updateTimerDisplay()
            });
            
            document.getElementById('confirmReflectionBtn').addEventListener('click', () => {
                const { duration, disruptions } = sessionDataForReflection;
                const quality = parseInt(document.querySelector('#reflectionModal .star-rating').dataset.rating) || 0;
                document.getElementById('reflectionModal').style.display = 'none';
                if (quality <= 3) {
                    showReasonModal(duration, disruptions, quality);
                } else {
                    stopAndSaveSession(duration, disruptions, quality, null);
                }
            });
            
            document.getElementById('saveGoalsBtn').addEventListener('click', saveGoals);
            
            document.getElementById('saveReasonBtn').addEventListener('click', async () => {
                const reason = document.getElementById('newReasonInput').value.trim();
                const { duration, disruptions, quality } = sessionDataForReflection;
                await stopAndSaveSession(duration, disruptions, quality, reason || 'Unspecified');
                document.getElementById('reasonModal').style.display = 'none';
                document.getElementById('improvementModal').style.display = 'flex'
            });
            
            document.getElementById('finishReflectionBtn').addEventListener('click', () => document.getElementById('improvementModal').style.display = 'none');
            
            document.querySelectorAll('.star-rating').forEach(w => {
                const s = w.querySelectorAll('.fa-star');
                w.addEventListener('mouseleave', () => s.forEach(i => i.classList.remove('hover')));
                s.forEach(i => {
                    i.addEventListener('mouseenter', e => {
                        const r = e.target.dataset.value;
                        s.forEach(t => t.classList.toggle('hover', t.dataset.value <= r))
                    });
                    i.addEventListener('click', e => {
                        const r = e.target.dataset.value;
                        w.dataset.rating = r;
                        s.forEach(t => t.classList.toggle('selected', t.dataset.value <= r))
                    })
                })
            });
        }
        
        async function openGoalsModal() {
            const twoWeeksAgo = new Date(new Date().getTime() - 14 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
            let totalMins = 0, totalSessions = 0, workDays = new Set(), totalDis = 0;
            Object.entries(focusedTimeData).forEach(([d, data]) => {
                if (d >= twoWeeksAgo && !isDayOff(d)) {
                    workDays.add(d);
                    (data.sessions || []).forEach(s => {
                        totalMins += s.duration / 60;
                        totalSessions++;
                        totalDis += (s.disruptions || 0)
                    })
                }
            });
            const avgDaily = workDays.size > 0 ? totalMins / workDays.size : 30;
            const avgSess = totalSessions > 0 ? totalMins / totalSessions : 25;
            const avgMinsPerDis = totalDis > 0 ? totalMins / totalDis : (avgDaily > 0 ? avgDaily : 30);
            document.getElementById('todayFocusGoal').value = Math.round(avgDaily * 1.05);
            document.getElementById('avgSessionGoal').value = Math.round(avgSess * 1.05);
            document.getElementById('disruptionGoal').value = Math.round(avgMinsPerDis * 1.05);
            document.getElementById('goalsModal').style.display = 'flex';
        }

        async function saveGoals() {
            const today = new Date().toISOString().slice(0, 10);
            const goalsData = {
                dailyGoal: parseInt(document.getElementById('todayFocusGoal').value),
                sessionGoal: parseInt(document.getElementById('avgSessionGoal').value),
                disruptionGoal: parseInt(document.getElementById('disruptionGoal').value)
            };
            if (Object.values(goalsData).some(v => isNaN(v) || v <= 0)) {
                showMessage("Please enter valid positive goals.");
                return
            }
            try {
                await setDoc(doc(db, `artifacts/${APP_ID_FOR_FIRESTORE}/users/${userId}/goals`, today), goalsData);
                showMessage("Goals saved!");
                document.getElementById('goalsModal').style.display = 'none';
            } catch (e) {
                console.error("Error saving goals:", e);
            }
        }

        function showReasonModal(duration, disruptions, quality) {
            sessionDataForReflection = { duration, disruptions, quality };
            const container = document.getElementById('pastReasonsContainer');
            container.innerHTML = '';
            lowQualityReasons.forEach(r => {
                const b = document.createElement('button');
                b.className = 'btn text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 p-2';
                b.textContent = r;
                b.onclick = () => document.getElementById('newReasonInput').value = r;
                container.appendChild(b)
            });
            document.getElementById('reasonModal').style.display = 'flex';
        }

        function scheduleNextNotification() {
            if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
            if (!notificationsEnabled || !running) return;
            notificationTimeoutId = setTimeout(() => {
                if (Notification.permission === 'granted') new Notification('Still focusing?');
                scheduleNextNotification()
            }, 15 * 60 * 1000);
        }

        function showMessage(msg) {
            document.getElementById('modalMessage').textContent = msg;
            document.getElementById('messageModal').style.display = 'flex'
        }
        
        function showConfirm(msg) {
            return new Promise(resolve => {
                document.getElementById('confirmMessage').textContent = msg;
                document.getElementById('confirmModal').style.display = 'flex';
                document.getElementById('confirmOkBtn').onclick = () => {
                    document.getElementById('confirmModal').style.display = 'none';
                    resolve(true)
                };
                document.getElementById('confirmCancelBtn').onclick = () => {
                    document.getElementById('confirmModal').style.display = 'none';
                    resolve(false)
                }
            })
        }
    </script>
</body>
</html>

